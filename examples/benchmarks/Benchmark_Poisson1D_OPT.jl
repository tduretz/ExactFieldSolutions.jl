using Plots, SparseArrays, Symbolics, SparseDiffTools, Printf, ExactFieldSolutions
import LinearAlgebra: norm, diag
import Statistics: mean

ð‘¢(ð‘¥)    =  cos(ð‘¥) # manufactured solution
âˆ‡ð‘¢(ð‘¥)   = -sin(ð‘¥) 
Î”ð‘¢(ð‘¥)   = -cos(ð‘¥)

Î²(ð‘¥)    = sin(ð‘¥) + 2
âˆ‡Î²(ð‘¥)   = cos(ð‘¥)

# Î²(ð‘¥)    = sin(ð‘¥/2) + 2
# âˆ‡Î²(ð‘¥)   = 0.5*cos(ð‘¥/2)

# Î²(ð‘¥)    =  cos(ð‘¥) 
# âˆ‡Î²(ð‘¥)   = -sin(ð‘¥)

# Î²(ð‘¥)    = cos(ð‘¥).^2 + 1
# âˆ‡Î²(ð‘¥)   = -2*sin(ð‘¥)*cos(ð‘¥)

# Î²(ð‘¥)    = ð‘¥^2 .+ 1
# âˆ‡Î²(ð‘¥)   = 2*ð‘¥

# Î²(ð‘¥)    =  1.0
# âˆ‡Î²(ð‘¥)   =  0.0
ð‘ž(ð‘¥)    = -Î²(ð‘¥)*âˆ‡ð‘¢(ð‘¥) 
âˆ‡ð‘ž(ð‘¥)   = -(âˆ‡Î²(ð‘¥)*âˆ‡ð‘¢(ð‘¥) + Î²(ð‘¥)*Î”ð‘¢(ð‘¥))

function Residual_OPT!(F, T, Ta, b, k, Î”x, x)
    for i in eachindex(T)
        if i==1 || i==length(F)                # West boundary
            F[i] = T[i] - Ta[i]
       else
            Tâ‚ = T[i-1]
            Tâ‚‚ = T[i]  
            Tâ‚ƒ = T[i+1]
            Îºâ‚ = k[i-1]
            Îºâ‚‚ = k[i]  
            Îºâ‚ƒ = k[i+1]
            fâ‚ = b[i-1]
            fâ‚‚ = b[i]  
            fâ‚ƒ = b[i+1]
            # F[i] = T[i-1] - 2*T[i] + T[i+1]

            # dx=1.0
            F[i] = 0.4978603665850510752848937882457382975079032586295007805567435495792873861864445Tâ‚*Îºâ‚ + 0.5041331747919146658946469112076253319780031840006510416666666666666666666666644Tâ‚*Îºâ‚‚ - 0.001993541376964808592200014321776715416656155757248487021381450420712613813555936Tâ‚*Îºâ‚ƒ - 0.4958668252080862107189496157389361850119223534593291570309139023719352534769209Tâ‚‚*Îºâ‚ - 1.008266349583829219379212579118150946063299973805745442708333333333333333333325Tâ‚‚*Îºâ‚‚ - 0.4958668252080862107189496157389361850119223534593291570309139023719352534769209Tâ‚‚*Îºâ‚ƒ - 0.001993541376964808592200014321776715416656155757248487021381450420712613813555936Tâ‚ƒ*Îºâ‚ + 0.5041331747919146658946469112076253319780031840006510416666666666666666666666644Tâ‚ƒ*Îºâ‚‚ + 0.4978603665850510752848937882457382975079032586295007805567435495792873861864445Tâ‚ƒ*Îºâ‚ƒ
            s    = 0.08275862068965547077027949122038863657921763045360473828744608713996651812768519fâ‚ + 0.8344827586206904277345047219193667810420913280864945487195259435480217587629177fâ‚‚ + 0.08275862068965547077027949122038863657921763045360473828744608713996651812768411fâ‚ƒ
            
            # dx= 0.5
            # F[i] = 0.9997391144053448673057434972410154271368091357389749174494248313414523447277115Tâ‚*Îºâ‚ + 1.000520569731932356832606230886047645374977340300877888997395833333333333333322Tâ‚*Îºâ‚‚ - 0.0002596841372780064986373936911090432033688557567074894905090332031249999999971199Tâ‚*Îºâ‚ƒ - 0.9994794302680602007700009595692227720387338241374067634699149296099880227887534Tâ‚‚*Îºâ‚ - 2.001041139463864713665212461772095290749954680601755777994791666666666666666644Tâ‚‚*Îºâ‚‚ - 0.9994794302680744116247161616210329763513679305712381998697916666666666666666695Tâ‚‚*Îºâ‚ƒ - 0.0002596841372851110586332567286105981537236682776698385498224017314643219389551707Tâ‚ƒ*Îºâ‚ + 1.000520569731932356832606230886047645374977340300877888997395833333333333333322Tâ‚ƒ*Îºâ‚‚ + 0.9997391144053528626462442743689599626103851430040473739306131998697916666666695Tâ‚ƒ*Îºâ‚ƒ
            # s    = 0.04164859002169017209291479148800892739498616657754097900493636212152874046902749fâ‚ + 0.4167028199566142897362180621133252054738347500999952823679851887650471553570198fâ‚‚ + 0.04164859002169198545718834590404739875160928714075756714934073895080975565482161fâ‚ƒ
            
            # dx=0.25
            # F[i] = 1.999967444238872678318249115381149112055290297514193570841322457635677589671282Tâ‚*Îºâ‚ + 2.000065102106095550221967251565876229809267291178305943806966145833333333333294Tâ‚*Îºâ‚‚ - 3.254634449609366204130709548141113981086410452311004822452863057454427081980383e-05Tâ‚*Îºâ‚ƒ - 1.99993489789472130980166568630733730336244758516463023546307066267343581037846Tâ‚‚*Îºâ‚ - 4.000130204212191544576512440093788806431499930719534556070963541666666666666547Tâ‚‚*Îºâ‚‚ - 1.999934897894039410827168867790248896199045702815055847167968749999999999999997Tâ‚‚*Îºâ‚ƒ - 3.254634415503332596278291896387463613556198689533972879857229385663908160574436e-05Tâ‚ƒ*Îºâ‚ + 2.000065102106095772288256220046894403215749965359767278035481770833333333333273Tâ‚ƒ*Îºâ‚‚ + 1.999967444238538947239528574682610716680327319257533721004923184712727864583349Tâ‚ƒ*Îºâ‚ƒ
            # s = 0.02083276820835143895060781488869092804376298570474900421408785226399610716422711fâ‚ + 0.2083344635833325682818101629798621463624157874776385670264472471657768437580637fâ‚‚ + 0.02083276820833019899636795425730768050082309784604576949542988536142236929057058fâ‚ƒ
            
            # dx=0.125
            # F[i] = 3.999995930969974355974039915288500355559690192045841275184073219389988921671886Tâ‚*Îºâ‚ + 4.000008138003603409358273832504125184344562594897179174518777760386921399874664Tâ‚*Îºâ‚‚ - 4.068964701077757049590883727131034663821821754462841151204581061999003075751333e-06Tâ‚*Îºâ‚ƒ - 3.999991862012606294117474910643663989304925941944583097072989665761845473109498Tâ‚‚*Îºâ‚ - 8.000016276009472577075914679251781640170947825256714674801561441676749620592378Tâ‚‚*Îºâ‚‚ - 3.999991861995772189586456494374051190373182533511569812903695363958418515701236Tâ‚‚*Îºâ‚ƒ - 4.068957425120237732362671189980955048401356839260253331678031732399070091689224e-06Tâ‚ƒ*Îºâ‚ + 4.000008138005868723627075776281529428282990005821994581632950869453177195795688Tâ‚ƒ*Îºâ‚‚ + 3.99999593096052988163455946977888954619369948906282274947443511337041854858395Tâ‚ƒ*Îºâ‚ƒ
            # s = 0.01041664900618629088256246286046398396754420532204828463961517511412087818219624fâ‚ + 0.1041667019879682023889216524653764620759233957021724061598836700663165781103696fâ‚‚ + 0.0104166490060728780909945839787555231964520848410400453871541929610581670810159fâ‚ƒ
            
            
            F[i] -= s
        end
       
    end
    return nothing
end

Residual!(F, T, Ta, b, k, Î”x, x)    = Residual_OPT!(F, T, Ta, b, k, Î”x, x)

function main(Î”x, L)

    @show ncx = Int64(L / Î”x)

    # Parameters
    x   = (min=-L/2, max=L/2)
    xc  = LinRange(x.min+Î”x/2., x.max-Î”x/2., ncx)
    xv  = LinRange(x.min, x.max, ncx+1)

    # Allocations
    T   = zeros(ncx+1)
    b   = zeros(ncx+1)
    k   =  ones(ncx+1)
    F   = zeros(ncx+1)
    Î´T  = zeros(ncx+1)
    Ta  = zeros(ncx+1)

    for i in eachindex(k)
        Ta[i]   = ð‘¢(xv[i])
        k[i]    = Î²(xv[i])
        b[i]    =-âˆ‡ð‘ž(xv[i])
    end

    T .= Ta

    # Sparsity pattern
    input       = rand(ncx+1)
    output      = similar(input)
    Res_closed! = (F, T) -> Residual!(F, T, Ta, b, k, Î”x, x)
    sparsity    = Symbolics.jacobian_sparsity(Res_closed!, output, input)
    J           = Float64.(sparse(sparsity))
    colors      = matrix_colors(J)

    # Newton iterations
    for iter=1:10

        # Residual evaluation: T is found if F = 0
        Residual!(F, T, Ta, b, k, Î”x, x)
        Res_closed! = (F, T) -> Residual!(F, T, Ta, b, k, Î”x, x)
        r = norm(F)/ncx
        @printf("## Iteration %06d: r = %1.2e ##\n", iter, r)
        if r < 1e-10 break end
            
        # Jacobian assembly
        forwarddiff_color_jacobian!(J, Res_closed!, T, colorvec = colors)

        # Solve
        Î´T   .= .-J\F

        # update
        T    .+= Î´T
    end


    # # Evaluate exact solution
    # for i in eachindex(T)
    #     sol   = Poisson1D_VarCoeff([xc[i]] )
    #     Ta[i] = sol.u
    # end

    p1=plot(xlabel="x", ylabel="u", title="Solution")
    p1=plot!(xv, T, label="numerics")
    p1=plot!(xv, Ta, label="analytics")
    p2=plot(xv, k, title="coefficient")
    display(plot(p1, p2))

    # Error
    return mean(abs.(T .- Ta))
end

main( 1.0, 10)
# main( 0.5, 10)
# main( 0.25, 10)
# main( 0.125, 10)

# function ConvergenceAnalysis()

#     # Space
#     L   = 2.
#     # Ncx = [20, 40, 80].*3  
#     Ncx = [10, 20, 30].*1 
#     Î”xv = L ./ Ncx
#     Ïµx  = zero(Î”xv)
#     for i in eachindex(Ncx)
#        Ïµx[i] = main(Î”xv[i], Ncx[i], L)
#     end

#     @show Ïµx

#     p1 = plot(xlabel="log10(1/Î”x)", ylabel="log10(Ïµx)")
#     p1 = scatter!( log10.( 1.0./Î”xv ), log10.(Ïµx), label="Ïµ")
#     p1 = plot!( log10.( 1.0./Î”xv ), log10.(Ïµx[1]) .- 1.0* ( log10.( 1.0./Î”xv ) .- log10.( 1.0./Î”xv[1] ) ), label="O1"  ) 
#     p1 = plot!( log10.( 1.0./Î”xv ), log10.(Ïµx[1]) .- 2.0* ( log10.( 1.0./Î”xv ) .- log10.( 1.0./Î”xv[1] ) ), label="O2"  ) 
#     p1 = plot!( log10.( 1.0./Î”xv ), log10.(Ïµx[1]) .- 4.0* ( log10.( 1.0./Î”xv ) .- log10.( 1.0./Î”xv[1] ) ), label="O4"  ) 

#     display(plot(p1))
# end

# ConvergenceAnalysis()